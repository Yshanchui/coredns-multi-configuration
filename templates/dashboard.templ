package templates

templ DashboardPage() {
	@Layout("é›†ç¾¤ç®¡ç†") {
		<div class="header">
			<div class="logo">ğŸŒ CoreDNS Manager</div>
			<div style="display: flex; gap: 1rem; align-items: center;">
				<button class="btn btn-primary" onclick="showAddClusterModal()">
					â• æ·»åŠ é›†ç¾¤
				</button>
				<a href="/logout" class="btn btn-secondary">é€€å‡ºç™»å½•</a>
			</div>
		</div>
		
		<div class="container">
			<h2 style="margin-bottom: 1.5rem;">é›†ç¾¤åˆ—è¡¨</h2>
			
			<div id="clusters-container" class="grid grid-cols-2">
				<div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
					<span class="loading" style="width: 2rem; height: 2rem;"></span>
					<p style="margin-top: 1rem;">åŠ è½½é›†ç¾¤åˆ—è¡¨...</p>
				</div>
			</div>
		</div>
		
		<!-- Add Cluster Modal -->
		<div id="add-cluster-modal" class="modal" style="display: none;">
			<div class="modal-content">
				<div class="modal-header">
					<h3 class="modal-title">æ·»åŠ æ–°é›†ç¾¤</h3>
					<button class="close-btn" onclick="hideAddClusterModal()">&times;</button>
				</div>
				
				<div id="add-cluster-error"></div>
				
				<form id="add-cluster-form" onsubmit="handleAddCluster(event)">
					<div class="form-group">
						<label class="form-label" for="cluster-name">é›†ç¾¤åç§°</label>
						<input type="text" id="cluster-name" class="form-input" required placeholder="ä¾‹å¦‚: production-cluster"/>
					</div>
					
					<div class="form-group">
						<label class="form-label" for="cluster-kubeconfig">Kubeconfig</label>
						<textarea id="cluster-kubeconfig" class="form-textarea" required placeholder="ç²˜è´´ kubeconfig å†…å®¹..."></textarea>
					</div>
					
					<div style="display: flex; gap: 1rem; justify-content: flex-end;">
						<button type="button" class="btn btn-secondary" onclick="hideAddClusterModal()">å–æ¶ˆ</button>
						<button type="submit" class="btn btn-primary" id="add-cluster-btn">
							<span id="add-cluster-text">æ·»åŠ é›†ç¾¤</span>
							<span id="add-cluster-loading" class="loading" style="display: none;"></span>
						</button>
					</div>
				</form>
			</div>
		</div>
		
		<!-- CoreDNS Config Modal -->
		<div id="coredns-modal" class="modal" style="display: none;">
			<div class="modal-content" style="max-width: 900px;">
				<div class="modal-header">
					<h3 class="modal-title" id="coredns-modal-title">CoreDNS é…ç½®</h3>
					<button class="close-btn" onclick="hideCoreDNSModal()">&times;</button>
				</div>
				
				<div id="coredns-content">
					<div style="text-align: center; padding: 2rem;">
						<span class="loading" style="width: 2rem; height: 2rem;"></span>
					</div>
				</div>
			</div>
		</div>
		
		@DashboardScript()
	}
}

templ DashboardScript() {
	<script>
		let currentClusterId = null;
		
		document.addEventListener('DOMContentLoaded', loadClusters);
		
		async function loadClusters() {
			try {
				const response = await fetch('/api/clusters');
				if (!response.ok) throw new Error('Failed to load clusters');
				const clusters = await response.json();
				renderClusters(clusters);
			} catch (error) {
				document.getElementById('clusters-container').innerHTML = 
					'<div class="alert alert-error">åŠ è½½é›†ç¾¤åˆ—è¡¨å¤±è´¥: ' + error.message + '</div>';
			}
		}
		
		function renderClusters(clusters) {
			const container = document.getElementById('clusters-container');
			
			if (clusters.length === 0) {
				container.innerHTML = '<div style="text-align: center; padding: 3rem; color: var(--text-secondary); grid-column: 1/-1;">' +
					'<p style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“­</p>' +
					'<p>æš‚æ— é›†ç¾¤ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </p></div>';
				return;
			}
			
			let html = '';
			for (let i = 0; i < clusters.length; i++) {
				const cluster = clusters[i];
				const statusClass = cluster.connected ? 'badge-success' : 'badge-danger';
				const statusText = cluster.connected ? 'âœ“ å·²è¿æ¥' : 'âœ— æœªè¿æ¥';
				const errorHtml = cluster.error ? '<p style="color: var(--danger);">é”™è¯¯: ' + cluster.error + '</p>' : '';
				
				html += '<div class="card cluster-card" onclick="showCoreDNSConfig(\'' + cluster.id + '\', \'' + cluster.name + '\')">' +
					'<div class="cluster-header">' +
					'<span class="cluster-name">' + cluster.name + '</span>' +
					'<span class="badge ' + statusClass + '">' + statusText + '</span>' +
					'</div>' +
					'<div class="cluster-info">' +
					'<p>ID: ' + cluster.id.substring(0, 8) + '...</p>' +
					'<p>æ·»åŠ æ—¶é—´: ' + new Date(cluster.created_at).toLocaleString('zh-CN') + '</p>' +
					errorHtml +
					'</div>' +
					'<div style="margin-top: 1rem; display: flex; gap: 0.5rem;">' +
					'<button class="btn btn-secondary" onclick="event.stopPropagation(); showCoreDNSConfig(\'' + cluster.id + '\', \'' + cluster.name + '\')">æŸ¥çœ‹ CoreDNS</button>' +
					'<button class="btn btn-danger" onclick="event.stopPropagation(); deleteCluster(\'' + cluster.id + '\', \'' + cluster.name + '\')">åˆ é™¤</button>' +
					'</div></div>';
			}
			container.innerHTML = html;
		}
		
		function showAddClusterModal() {
			document.getElementById('add-cluster-modal').style.display = 'flex';
			document.getElementById('add-cluster-form').reset();
			document.getElementById('add-cluster-error').innerHTML = '';
		}
		
		function hideAddClusterModal() {
			document.getElementById('add-cluster-modal').style.display = 'none';
		}
		
		async function handleAddCluster(event) {
			event.preventDefault();
			
			const btn = document.getElementById('add-cluster-btn');
			const text = document.getElementById('add-cluster-text');
			const loading = document.getElementById('add-cluster-loading');
			const errorDiv = document.getElementById('add-cluster-error');
			
			btn.disabled = true;
			text.style.display = 'none';
			loading.style.display = 'inline-block';
			
			const name = document.getElementById('cluster-name').value;
			const kubeconfig = document.getElementById('cluster-kubeconfig').value;
			
			try {
				const response = await fetch('/api/clusters', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ name, kubeconfig }),
				});
				
				const data = await response.json();
				
				if (response.ok) {
					hideAddClusterModal();
					loadClusters();
				} else {
					errorDiv.innerHTML = '<div class="alert alert-error">' + (data.error || 'æ·»åŠ å¤±è´¥') + '</div>';
				}
			} catch (error) {
				errorDiv.innerHTML = '<div class="alert alert-error">ç½‘ç»œé”™è¯¯</div>';
			} finally {
				btn.disabled = false;
				text.style.display = 'inline';
				loading.style.display = 'none';
			}
		}
		
		async function deleteCluster(id, name) {
			if (!confirm('ç¡®å®šè¦åˆ é™¤é›†ç¾¤ "' + name + '" å—ï¼Ÿ')) return;
			
			try {
				const response = await fetch('/api/clusters/' + id, { method: 'DELETE' });
				if (response.ok) {
					loadClusters();
				} else {
					const data = await response.json();
					alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
				}
			} catch (error) {
				alert('ç½‘ç»œé”™è¯¯');
			}
		}
		
		async function showCoreDNSConfig(clusterId, clusterName) {
			currentClusterId = clusterId;
			document.getElementById('coredns-modal').style.display = 'flex';
			document.getElementById('coredns-modal-title').textContent = clusterName + ' - CoreDNS é…ç½®';
			document.getElementById('coredns-content').innerHTML = 
				'<div style="text-align: center; padding: 2rem;">' +
				'<span class="loading" style="width: 2rem; height: 2rem;"></span>' +
				'<p style="margin-top: 1rem; color: var(--text-secondary);">åŠ è½½é…ç½®...</p></div>';
			
			try {
				const response = await fetch('/api/clusters/' + clusterId + '/coredns');
				if (!response.ok) throw new Error('Failed to load CoreDNS config');
				const data = await response.json();
				renderCoreDNSConfig(data);
			} catch (error) {
				document.getElementById('coredns-content').innerHTML = 
					'<div class="alert alert-error">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
			}
		}
		
		function hideCoreDNSModal() {
			document.getElementById('coredns-modal').style.display = 'none';
			currentClusterId = null;
		}
		
		function renderCoreDNSConfig(data) {
			const serviceName = (data.service && data.service.metadata && data.service.metadata.name) || 'kube-dns';
			const configMapName = (data.configmap && data.configmap.metadata && data.configmap.metadata.name) || 'coredns';
			const serviceIP = data.service_ip || 'N/A';
			const corefile = data.corefile || '';
			const rules = data.forward_rules || [];
			
			let rulesHtml = '';
			if (rules.length === 0) {
				rulesHtml = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">æš‚æ— è½¬å‘è§„åˆ™</p>';
			} else {
				for (let i = 0; i < rules.length; i++) {
					const rule = rules[i];
					rulesHtml += '<div class="rule-item">' +
						'<div><span class="rule-domain">' + rule.namespace + '.svc.cluster.local:53</span>' +
						'<span style="margin: 0 0.5rem;">â†’</span>' +
						'<span class="rule-target">' + rule.target_ip + '</span></div>' +
						'<button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="deleteForwardRule(\'' + rule.namespace + '\')">åˆ é™¤</button></div>';
				}
			}
			
			document.getElementById('coredns-content').innerHTML = 
				'<div class="service-info">' +
				'<div class="info-card"><div class="info-label">Service Name</div><div class="info-value">' + serviceName + '</div></div>' +
				'<div class="info-card"><div class="info-label">Cluster IP</div><div class="info-value">' + serviceIP + '</div></div>' +
				'<div class="info-card"><div class="info-label">ConfigMap</div><div class="info-value">' + configMapName + '</div></div>' +
				'</div>' +
				'<div class="tabs">' +
				'<button class="tab active" onclick="switchTab(\'rules\', this)">è½¬å‘è§„åˆ™</button>' +
				'<button class="tab" onclick="switchTab(\'corefile\', this)">Corefile</button>' +
				'</div>' +
				'<div id="tab-rules">' +
				'<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">' +
				'<h4>å·²é…ç½®çš„è½¬å‘è§„åˆ™</h4>' +
				'<button class="btn btn-primary" onclick="showAddRuleForm()">â• æ·»åŠ è§„åˆ™</button></div>' +
				'<div id="add-rule-form" style="display: none; margin-bottom: 1rem;">' +
				'<div class="card" style="padding: 1rem;">' +
				'<div style="display: flex; gap: 1rem; align-items: flex-end;">' +
				'<div class="form-group" style="flex: 1; margin-bottom: 0;"><label class="form-label">Namespace</label>' +
				'<input type="text" id="rule-namespace" class="form-input" placeholder="ä¾‹å¦‚: prod"/></div>' +
				'<div class="form-group" style="flex: 1; margin-bottom: 0;"><label class="form-label">ç›®æ ‡ DNS IP</label>' +
				'<input type="text" id="rule-target-ip" class="form-input" placeholder="ä¾‹å¦‚: 10.96.0.10"/></div>' +
				'<button class="btn btn-primary" onclick="addForwardRule()">æ·»åŠ </button>' +
				'<button class="btn btn-secondary" onclick="hideAddRuleForm()">å–æ¶ˆ</button></div>' +
				'<p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">å°†ç”Ÿæˆ: <code>namespace.svc.cluster.local:53 { forward . target_ip }</code></p>' +
				'</div></div>' +
				'<div class="rules-list" id="rules-list">' + rulesHtml + '</div></div>' +
				'<div id="tab-corefile" style="display: none;">' +
				'<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">' +
				'<h4>Corefile å†…å®¹</h4>' +
				'<button class="btn btn-primary" onclick="saveCorefile()" id="save-corefile-btn">ä¿å­˜ä¿®æ”¹</button></div>' +
				'<textarea id="corefile-editor" class="form-textarea" style="min-height: 400px; font-size: 0.9rem;">' + escapeHtml(corefile) + '</textarea></div>';
		}
		
		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}
		
		function switchTab(tabName, element) {
			document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
			element.classList.add('active');
			document.getElementById('tab-rules').style.display = tabName === 'rules' ? 'block' : 'none';
			document.getElementById('tab-corefile').style.display = tabName === 'corefile' ? 'block' : 'none';
		}
		
		function showAddRuleForm() {
			document.getElementById('add-rule-form').style.display = 'block';
		}
		
		function hideAddRuleForm() {
			document.getElementById('add-rule-form').style.display = 'none';
		}
		
		async function addForwardRule() {
			const namespace = document.getElementById('rule-namespace').value.trim();
			const targetIP = document.getElementById('rule-target-ip').value.trim();
			
			if (!namespace || !targetIP) {
				alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
				return;
			}
			
			try {
				const response = await fetch('/api/clusters/' + currentClusterId + '/rules', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ namespace: namespace, target_ip: targetIP }),
				});
				
				if (response.ok) {
					const title = document.getElementById('coredns-modal-title').textContent;
					showCoreDNSConfig(currentClusterId, title.split(' - ')[0]);
				} else {
					const data = await response.json();
					alert('æ·»åŠ å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
				}
			} catch (error) {
				alert('ç½‘ç»œé”™è¯¯');
			}
		}
		
		async function deleteForwardRule(namespace) {
			if (!confirm('ç¡®å®šè¦åˆ é™¤ ' + namespace + ' çš„è½¬å‘è§„åˆ™å—ï¼Ÿ')) return;
			
			try {
				const response = await fetch('/api/clusters/' + currentClusterId + '/rules/' + namespace, {
					method: 'DELETE',
				});
				
				if (response.ok) {
					const title = document.getElementById('coredns-modal-title').textContent;
					showCoreDNSConfig(currentClusterId, title.split(' - ')[0]);
				} else {
					const data = await response.json();
					alert('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
				}
			} catch (error) {
				alert('ç½‘ç»œé”™è¯¯');
			}
		}
		
		async function saveCorefile() {
			const corefile = document.getElementById('corefile-editor').value;
			const btn = document.getElementById('save-corefile-btn');
			
			btn.disabled = true;
			btn.textContent = 'ä¿å­˜ä¸­...';
			
			try {
				const response = await fetch('/api/clusters/' + currentClusterId + '/coredns', {
					method: 'PUT',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ corefile: corefile }),
				});
				
				if (response.ok) {
					alert('ä¿å­˜æˆåŠŸï¼CoreDNS é…ç½®å·²æ›´æ–°ã€‚');
				} else {
					const data = await response.json();
					alert('ä¿å­˜å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
				}
			} catch (error) {
				alert('ç½‘ç»œé”™è¯¯');
			} finally {
				btn.disabled = false;
				btn.textContent = 'ä¿å­˜ä¿®æ”¹';
			}
		}
	</script>
}
